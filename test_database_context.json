{
  "description": "Test cases for database context parameter functionality",
  "tests": [
    {
      "name": "Test 1: Initialize server",
      "request": {
        "jsonrpc": "2.0",
        "id": 1,
        "method": "initialize",
        "params": {}
      },
      "expected": {
        "result": {
          "protocolVersion": "2025-03-26",
          "capabilities": {
            "tools": {
              "list_changed": true
            }
          },
          "serverInfo": {
            "name": "mcp-server-mysql",
            "version": "0.1.0"
          }
        }
      }
    },
    {
      "name": "Test 2: List tools (verify database parameter exists)",
      "request": {
        "jsonrpc": "2.0",
        "id": 2,
        "method": "tools/list",
        "params": {}
      },
      "expected": {
        "result": {
          "tools": [
            {
              "name": "query",
              "input_schema": {
                "properties": {
                  "query": {},
                  "database": {
                    "type": "string",
                    "description": "Optional database name to use for this query"
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "name": "Test 3: Query without database parameter (uses default)",
      "request": {
        "jsonrpc": "2.0",
        "id": 3,
        "method": "tools/call",
        "params": {
          "name": "query",
          "arguments": {
            "query": "SELECT DATABASE() as current_db"
          }
        }
      },
      "expected": {
        "result": {
          "content": [
            {
              "type": "text",
              "text": "Query executed successfully"
            }
          ]
        }
      },
      "notes": "Should return the default database specified in --database argument"
    },
    {
      "name": "Test 4: Query with explicit database parameter",
      "request": {
        "jsonrpc": "2.0",
        "id": 4,
        "method": "tools/call",
        "params": {
          "name": "query",
          "arguments": {
            "query": "SELECT DATABASE() as current_db",
            "database": "dev_smartConnect_za"
          }
        }
      },
      "expected": {
        "result": {
          "content": [
            {
              "type": "text",
              "text": "dev_smartConnect_za"
            }
          ]
        }
      },
      "notes": "Should return 'dev_smartConnect_za' as the current database"
    },
    {
      "name": "Test 5: Query table without fully qualified name",
      "request": {
        "jsonrpc": "2.0",
        "id": 5,
        "method": "tools/call",
        "params": {
          "name": "query",
          "arguments": {
            "query": "SELECT COUNT(*) as count FROM crm_sites",
            "database": "dev_smartConnect_za"
          }
        }
      },
      "expected": {
        "result": {
          "content": [
            {
              "type": "text",
              "text": "Query executed successfully"
            }
          ]
        }
      },
      "notes": "Should work without needing database.table qualification"
    },
    {
      "name": "Test 6: Switch between multiple databases",
      "request": {
        "jsonrpc": "2.0",
        "id": 6,
        "method": "tools/call",
        "params": {
          "name": "query",
          "arguments": {
            "query": "SELECT DATABASE() as db1",
            "database": "mysql"
          }
        }
      },
      "expected": {
        "result": {
          "content": [
            {
              "type": "text",
              "text": "mysql"
            }
          ]
        }
      },
      "notes": "First query to 'mysql' database"
    },
    {
      "name": "Test 7: Continue with different database",
      "request": {
        "jsonrpc": "2.0",
        "id": 7,
        "method": "tools/call",
        "params": {
          "name": "query",
          "arguments": {
            "query": "SELECT DATABASE() as db2",
            "database": "dev_smartConnect_za"
          }
        }
      },
      "expected": {
        "result": {
          "content": [
            {
              "type": "text",
              "text": "dev_smartConnect_za"
            }
          ]
        }
      },
      "notes": "Second query to different database - should work independently"
    },
    {
      "name": "Test 8: Invalid database name",
      "request": {
        "jsonrpc": "2.0",
        "id": 8,
        "method": "tools/call",
        "params": {
          "name": "query",
          "arguments": {
            "query": "SELECT 1",
            "database": "nonexistent_database_12345"
          }
        }
      },
      "expected": {
        "error": {
          "code": -32006,
          "message": "Failed to set database context"
        }
      },
      "notes": "Should fail gracefully with proper error message"
    },
    {
      "name": "Test 9: Database name with special characters",
      "request": {
        "jsonrpc": "2.0",
        "id": 9,
        "method": "tools/call",
        "params": {
          "name": "query",
          "arguments": {
            "query": "SELECT DATABASE() as current_db",
            "database": "information_schema"
          }
        }
      },
      "expected": {
        "result": {
          "content": [
            {
              "type": "text",
              "text": "information_schema"
            }
          ]
        }
      },
      "notes": "Should handle database names with underscores correctly"
    },
    {
      "name": "Test 10: Complex query with joins using database parameter",
      "request": {
        "jsonrpc": "2.0",
        "id": 10,
        "method": "tools/call",
        "params": {
          "name": "query",
          "arguments": {
            "query": "SELECT COUNT(*) as total FROM crm_sites s LEFT JOIN crm_orgs o ON s.org_id = o.id WHERE s.active = 1",
            "database": "dev_smartConnect_za"
          }
        }
      },
      "expected": {
        "result": {
          "content": [
            {
              "type": "text",
              "text": "Query executed successfully"
            }
          ]
        }
      },
      "notes": "Should handle complex queries without qualification"
    }
  ],
  "test_instructions": {
    "setup": [
      "Ensure MySQL/MariaDB is running",
      "Create test database 'dev_smartConnect_za' if it doesn't exist",
      "Create sample tables 'crm_sites' and 'crm_orgs' with test data",
      "Grant appropriate permissions to test user"
    ],
    "execution": [
      "Run each test in sequence",
      "Verify responses match expected results",
      "Check error handling for invalid database names",
      "Verify database context switches correctly between queries"
    ],
    "manual_test_command": [
      "# Test with default database",
      "echo '{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"initialize\",\"params\":{}}' | ./target/release/mcp-server-mysql --username admin --password pass --database taxman",
      "",
      "# Test with explicit database parameter",
      "echo '{\"jsonrpc\":\"2.0\",\"id\":2,\"method\":\"tools/call\",\"params\":{\"name\":\"query\",\"arguments\":{\"query\":\"SELECT DATABASE()\",\"database\":\"dev_smartConnect_za\"}}}' | ./target/release/mcp-server-mysql --username admin --password pass --database taxman"
    ],
    "validation": [
      "Verify Test 3 returns the default database (from --database arg)",
      "Verify Test 4 returns 'dev_smartConnect_za' (from database param)",
      "Verify Test 5 succeeds without fully qualified table names",
      "Verify Test 6 and 7 show independent database contexts",
      "Verify Test 8 returns proper error for nonexistent database",
      "Verify all queries complete without hanging or connection issues"
    ]
  },
  "success_criteria": {
    "database_context_isolation": "Each query with database parameter should use that database independently",
    "backward_compatibility": "Queries without database parameter should still work using default database",
    "error_handling": "Invalid database names should return error code -32006",
    "performance": "Database context switching should add minimal overhead (<200ms)",
    "connection_management": "Connections should be properly returned to pool after each query"
  },
  "regression_tests": {
    "verify_existing_functionality": [
      "Test queries without database parameter still work",
      "Test fully qualified table names still work",
      "Test other tools (mysql, insert, update, delete) are unaffected",
      "Test dangerous query protection still works",
      "Test connection retry logic still works"
    ]
  }
}